#!/usr/bin/env bash
#------------------------{ Dev info }-----------------------------------------------------------------------------------
#Created by: Ivan Marov <ie.marov@gmail.com>
#Source: https://github.com/vaniacer/piu-piu-SH
# check bash version
case ${BASH_VERSINFO[@]::2} in [1-3]' '[0-9][0-9]|[1-3]' '[0-9]|'4 '[0-1])
    echo -e "\nYour BASH is too short!) 4.2+ required to run this game, your is - ${BASH_VERSINFO[@]}"
    exit 1;;
esac
#--------------------------------------------------------------------+
#Color picker, usage: printf $BLD$CUR$RED$BBLU'Hello World!'$DEF     |
#-------------------------+--------------------------------+---------+
#       Text color        |       Background color         |         |
#-----------+-------------+--------------+-----------------+         |
# Base color|Lighter shade| Base color   | Lighter shade   |         |
#-----------+-------------+--------------+-----------------+         |
BLK='\e[30m'; blk='\e[90m'; BBLK='\e[40m'; bblk='\e[100m' #| Black   |
RED='\e[31m'; red='\e[91m'; BRED='\e[41m'; bred='\e[101m' #| Red     |
GRN='\e[32m'; grn='\e[92m'; BGRN='\e[42m'; bgrn='\e[102m' #| Green   |
YLW='\e[33m'; ylw='\e[93m'; BYLW='\e[43m'; bylw='\e[103m' #| Yellow  |
BLU='\e[34m'; blu='\e[94m'; BBLU='\e[44m'; bblu='\e[104m' #| Blue    |
MGN='\e[35m'; mgn='\e[95m'; BMGN='\e[45m'; bmgn='\e[105m' #| Magenta |
CYN='\e[36m'; cyn='\e[96m'; BCYN='\e[46m'; bcyn='\e[106m' #| Cyan    |
WHT='\e[37m'; wht='\e[97m'; BWHT='\e[47m'; bwht='\e[107m' #| White   |
#-------------------------{ Effects }----------------------+---------+
DEF='\e[0m'   #Default color and effects                             |
BLD='\e[1m'   #Bold\brighter                                         |
DIM='\e[2m'   #Dim\darker                                            |
CUR='\e[3m'   #Italic font                                           |
UND='\e[4m'   #Underline                                             |
INV='\e[7m'   #Inverted                                              |
COF='\e[?25l' #Cursor Off                                            |
CON='\e[?25h' #Cursor On                                             |
#------------------------{ Functions }-------------------------------+
# Text positioning, usage: XY 10 10 'Hello World!'                   |
XY () { printf "\e[$2;${1}H$3"; }                                   #|
# Print line, usage: line - 10 | line -= 20 | line 'Hello World!' 20 |
line () { printf -v _L %$2s; printf -- "${_L// /$1}"; }             #|
# Create sequence like {0..(X-1)}                                    |
que () { printf -v _N %$1s; _N=(${_N// / 1}); printf "${!_N[*]}"; } #|
#----{ Start opt }------------------------------------{ description  }---------------------{ def. values }--------------
  background=true                                     # background objects visibility             (true)
     enumber=0                                        # current enemy counter                     (0)
       enmax=100                                      # max number of akiens                      (10)
       month=$(date +'%m')                            # get current month                       
        life=3                                        # life counter                              (3)
        ammo=100                                      # ammo counter                              (100)
         DHC=$BLK                                     # default hero color                        ($BLK)
         DSC=$RED                                     # default symbol color                      ($RED)
         DHS=★                                        # default symbol                            (★)
         spd=0.0001                                   # game\read speed                           (0.0001)
         MSN=1111                                     # messanger randomizer                      (1111)
          LX=1                                        # grass X counter                         
          ad='Die alien scum!'                        # ad plane message                          'Die alien scum!'
           G=1                                        # gun                                       (1)(max 5)
[[ -e ~/.piuconf ]] && . ~/.piuconf
#================================================{ Messages }===========================================================
case "$day$month" in
    1101) ad='Happy birthday Yura $)';;
    0202) ad='It is groundhog day !)';;
    2802) ad='Happy birthday Matvey !)';;
    2002) ad='Happy birthday Romka !)';;
    3006) ad='Happy birthday Natusya !)';;
    0703) ad='The 8th of March is comming...';;
    0803) ad='Hold on guyz $)';;
esac

sprite_help () {
           x=$[$endx/2-25/2]
           y=$[$endy/2-5]

      sprite=(         "\e[$y;${x}H                   ^"
            "\e[$[$y+1];${x}H                   ${RED}W$DEF"
  "\e[$[$y+2];${x}H${BLD}Control with:$DEF  < ${RED}A S D$DEF >"
                  "\e[$[$y+3];${x}H                   v"
  "\e[$[$y+5];${x}H${BLD}Shoot\select with:$DEF ${YLW}P $BLD$red-=$GRN>$DEF")
}

sprite_lose () {
           x=$[$endx/2-25/2]
           y=$[$endy/2-5]
         CM1=$BLD$red; CM2=$DIM$RED
      sprite=("\e[$y;${x}H$CM1  ____    _    __  __ _____$DEF"
         "\e[$[$y+1];${x}H$red / ___|  / \  |  \/  | ____|$DEF"
         "\e[$[$y+2];${x}H$red| | __  / _ \ | |\/| |  _|$DEF"
         "\e[$[$y+3];${x}H$RED| |_\ \/ ___ \| |  | | |___$DEF"
         "\e[$[$y+4];${x}H$CM2 \____/_/   \_\_|__|_|_____|$DEF"
         "\e[$[$y+5];${x}H$CM1  / _ \ \   / / ____|  _ \ $DEF"
         "\e[$[$y+6];${x}H$red | | | \ \ / /|  _| | |_) |$DEF"
         "\e[$[$y+7];${x}H$RED | |_| |\ V / | |___|  _ < $DEF"
         "\e[$[$y+8];${x}H$CM2  \___/  \_/  |_____|_| \_|$DEF")
}

sprite_win () {

           x=$[$endx/2-25/2]
           y=$[$endy/2-5]
         CM1=$BLD$grn; CM2=$DIM$GRN

      sprite=("\e[$y;${x}H${CM1}__        ______ _    _$DEF"
           "\e[$[$y+1];${x}H$grn\ \      / /____| |  | |$DEF"
           "\e[$[$y+2];${x}H$grn \ \ /\ / /  _| | |  | |$DEF"
           "\e[$[$y+3];${x}H$GRN  \ V  V /| |___| |__| |__$DEF"
           "\e[$[$y+4];${x}H$CM2 __\_/\_/_|_____|____|____|$DEF"
           "\e[$[$y+5];${x}H$CM1|  _ \ / _ \| \ | | ____| |$DEF"
           "\e[$[$y+6];${x}H$grn| | | | | | |  \| |  _| | |$DEF"
           "\e[$[$y+7];${x}H$GRN| |_| | |_| | |\  | |___|_|$DEF"
           "\e[$[$y+8];${x}H$CM2|____/ \___/|_| \_|_____(_)$DEF")
}

#================================================{ Sprites }============================================================
case $month in
    0[1-4]|12)
        SKY=$DEF$bwht         # winter & early spring sky
        LND=$DEF$BLD$WHT$BWHT # winter & early spring land
        CLD=30                # winter & early spring clouds rnd
        TRE=50;;              # winter & early spring trees rnd

    0[5-8]   )
        SKY=$DEF$bcyn         # late spring & summer sky
        LND=$DEF$DIM$GRN$bgrn # late spring & summer land
        CLD=50                # late spring & summer clouds rnd
        TRE=20;;              # late spring & summer trees rnd

    09|1[0-1])
        SKY=$DEF$BCYN         # autumn sky
        LND=$DEF$DIM$YLW$BGRN # autumn land
        CLD=20                # autumn clouds rnd
        TRE=50;;              # autumn trees rnd
esac
gun=(─ ─ ═ ≡ ≣ 𝄚)
grass=(│ ' ' ║ ' ' ░ ' ' ▒ ' ' ▓ ' ' █)    # grass types
#------------------------{ Hero1 }--------------------------------------------------------------------------------------
mainrotor=(" ${blk}_   ${blk}_   ${blk}_   ${blk}_  ${blk}_ ${blk}_ ${blk}_  ${blk}_   ${blk}_   ${blk}_   ${blk}_$SKY"
           "_Z_ _Z_ _Z_ _Z_ ${blk}_ ${blk}_ ${blk}_ _Z_ _Z_ _Z_ _Z_$SKY"
           "_Z_ _Z_ _Z_ _Z_ _Z_ ${blk}_ _Z_ _Z_ _Z_ _Z_ _Z_$SKY"
           "_Z_ _Z_ _Z_ _Z_ ${blk}_ ${blk}_ ${blk}_ _Z_ _Z_ _Z_ _Z_$SKY")
tailrotor=("${blk}"'\\' "${blk}─" "${blk}/" "${blk}|")
sprite_hero1 () {
    server_read
    mov && HER[i]="hero1 $H1X $H1Y 6 14 $SC $SM $CS $CL $AS $AL"
    CM1=$SKY$H1C$BLD CM2=$SKY$DIM$H1C CM3=$SKY$H1C CM4=$SKY$BLD$H1C$UND
    X1="\\e[$[H1Y+5];$[H1X+7]H"
    re="alien $[H1X+13] $[H1Y+2] .*|alien $[H1X+12] $[H1Y+2] .*|alien $[H1X+12] $[H1Y+1] .*|alien $[H1X+11] $[H1Y+1] .*"
    [[ ${ENM[@]} =~ $re ]] && { T=($BASH_REMATCH); e=${T[@]:11:1}; x=${T[@]:1:1}; y=${T[@]:2:1}; unset ENM[e]; boom $x $y; }
    #0123456789ABCDEF
    #1              
    #2 __ ___________
    #3 |X\___.-╨─｡_
    #4 `─´‾‾‷\°★ º¯]─
    #5        ‾‾‾‾‾
    #6
    #                               1   2                          3          4         5         6         7         8          9         A         B         C         D          E    F
    cut "\\e[$H1Y;${H1X}H$SKY"     ' ' ' '                        ' '        ' '       ' '       ' '       ' '       ' '        ' '       ' '       ' '       ' '       ' '        ' '  ' '                    #1   
    cut "\\e[$[H1Y+1];${H1X}H$CM3" ' ' '_'                        '_'        ' '                                          ${mainrotor[AS]}                                                                     #2
    cut "\\e[$[H1Y+2];${H1X}H$CM2" ' ' '|' ${tailrotor[AS]} "$CM1"'\\' "$CM1"'_' "$CM1"'_' "$CM1"'_' "$CM3"'.' "$CM3"'-'  "$CM3"'╨' "$CM4"'─' "$CM4"'｡' "$CM1"'_' "$SKY"' '  "$SKY"' '                         #3
    cut "\\e[$[H1Y+3];${H1X}H$CM2" ' ' '`'                        '─'        '´'       '‾'       '‾'       '‷'       '\\' "$blk"'°' "$S1C"'★' "$SKY"' ' "$blk"'º' "$blk"'¯'  "$CM1"']'  $SKY$BLK${gun[$G]}$SKY #4
    cut "\\e[$[H1Y+4];${H1X}H$CM2" ' ' ' '                        ' '        ' '       ' '       ' '       ' '       ' '        '‾'       '‾'       '‾'       '‾'       '‾'  "$SKY"' '  ' '                    #5
    cut "\\e[$[H1Y+5];${H1X}H$SKY" ''  ''                         ''         ''        ''        ''        ''   "$X1"' '        ' '       ' '       ' '       ' '       ' '        ' '                         #6
}
#------------------------{ Ad plane }-----------------------------------------------------------------------------------
flame1=("$red-"       "$ylw~"       "$red- $RED~" "$ylw-")
flame2=("$ylw-"       "$red- $RED~" "$red~"       "$YLW~")
flame3=("$red- $RED~" "$red~"       "$YLW~"       "$ylw-")
for ((i=0; i<${#ad}; i++)); do ad_new+="$BLD$red${ad:$i:1} "; done
new_ad=( ${ad_new//  /_Z_ } ) line=( ${new_ad[@]//*/$blk-} ) width=$((19+${#new_ad[@]}))
sprite_msngr () {
    mov && BP2[i]="msngr $OX $OY 4 $width $SC $SM $CS $CL $AS $AL" || { unset BP2[i]; return; }
    CM1=$SKY$BLD$blk CM2=$SKY$DIM$blk CM3=$SKY$blk
    X1="\\e[$OY;$[OX+7]H"     X2="\\e[$[OY+1];$[OX+1]H" X3="\\e[$[OY+1];$[OX+12]H"
    X4="\\e[$[OY+3];$[OX+4]H" X5="\\e[$[OY+3];$[OX+12]H"
    #0123456789ABCD...
    #1       __
    #2 _____/_/   +--------------------+~
    #3(°_\ |_)---<| Die alien scum DIE! -~
    #4    \|      +--------------------~
    #                            1          2   3         4       5         6          7         8   9   A   B   C       D   E   F  ...
    cut "\\e[$OY;${SX}H$CM1"     ''        ''  ''        ''      ''         ''        ''   "$X1"'_' '_'                                                                #1
    cut "\\e[$[OY+1];${SX}H$CM2" ''   "$X2"'_' '_'       '_'     '_'        '_'       '/'       '_' '/' ' ' ''  '' "$X3"'+' '-' '-' ${line[@]} ${flame1[AS]}       ' ' #2
    cut "\\e[$[OY+2];${SX}H$CM1" '(' "$UND"'°' ' ' "$CM2"'\\'    ' '  "$CM3"'|' "$UND"' ' "$CM3"')' '-' '-' '-' '<'     '|' ' ' ${new_ad[@]} ' ' $SKY${flame2[AS]} ' ' #3
    cut "\\e[$[OY+3];${SX}H$CM2" ''        ''  ''        '' "$X4"'\\' "$CM3"'|'       ' '       ''  ''  ''  ''  '' "$X5"'+' ${line[@]} ${flame3[AS]}               ' ' #4
}

#------------------------{ Aliens }-------------------------------------------------------------------------------------
CM1=$SKY$DIM$BLK CM2=$BLD$BLK
small=("${SKY}_Z_  ${SKY}_Z_  ${RED}o$CM1"
       "${SKY}_Z_  ${RED}o    ${SKY}_Z_$CM1"
       "${RED}o    ${SKY}_Z_  ${SKY}_Z_$CM1"
       "${SKY}_Z_  ${SKY}_Z_  ${SKY}_Z_$CM1")

CM1=$SKY$BLD$ylw CM2=$SKY$UND$BLD$grn
pumtop=( "$CM2"'\\'"$CM1" "$CM2"'\\'"$CM1" "$CM2|$CM1" "$CM2|$CM1" "$CM2/$CM1" "$CM2/$CM1")
pumface=("${RED}O ${RED}… ${RED}o$CM1"
         "${RED}… ${RED}o _Z_$CM1"
         "${RED}o _Z_     ${RED}O$CM1"
         "_Z_     _Z_     _Z_$CM1"
         "_Z_     _Z_     ${RED}O$CM1"
         "_Z_     ${RED}O ${RED}…$CM1")

sprite_alien () {
    case "$day$month" in
        3110)
        mov && ENM[i]="alien $OX $OY 3 5 $SC $SM $CS $CL $AS 5 $i" || { unset ENM[i]; ((enumber--)); return; }
        X1="\\e[$OY;$[OX+1]H" X2="\\e[$[OY+2];$[OX+1]H"
        CM1=$SKY$BLD$ylw CM2=$SKY$UND$DIM$grn CM3=$SKY$ylw
        #012345
        #1 _\_
        #2(O…o)
        #3 `¯´
        #                            1        2   3             4   5
        cut "\\e[$OY;${SX}H$CM1"     '' "$X1"'_' ${pumtop[AS]} '_'      #1
        cut "\\e[$[OY+1];${SX}H$CM1" '('         ${pumface[AS]}    ')'  #2
        cut "\\e[$[OY+2];${SX}H$CM1" '' "$X2"'`' '¯'           '´';;    #3

        *)
        mov && ENM[i]="alien $OX $OY 3 5 $SC $SM $CS $CL $AS 3 $i" || { unset ENM[i]; ((enumber--)); return; }
        X1="\\e[$OY;$[OX+1]H" X2="\\e[$[OY+2];$[OX+1]H"
        CM1=$SKY$DIM$BLK CM2=$BLD$BLK
        #012345
        #1 ___
        #2( o )
        #3 `¯´
        #                            1        2         3         4   5
        cut "\\e[$OY;${SX}H$CM1"     '' "$X1"'_' "$CM2"'_' "$CM1"'_'      #1
        cut "\\e[$[OY+1];${SX}H$CM1" '('       ${small[AS]}   ')'         #2
        cut "\\e[$[OY+2];${SX}H$CM1" '' "$X2"'`'       '¯'       '´';;    #3
    esac
}

#------------------------{ Clouds }-------------------------------------------------------------------------------------
case $month in
    0[1-4]|12) C1C=$SKY$DIM$CYN;; # winter & early spring
    0[5-8]   ) C1C=$SKY$DIM$WHT;; # late spring & summer
    09|1[0-1]) C1C=$SKY$blk    ;; # autumn
esac
sprite_cloud1 () {
    mov && BP1[i]="cloud1 $OX $OY 3 6 $SC $SM $CS $CL $AS $AL" || { unset BP1[i]; return; }
    X1="\\e[$OY;$[OX+1]H" X2="\\e[$[OY+2];$[OX+1]H"
    #0123456
    #1 ,-+.
    #2(    )
    #3 `+-´
    #                              1        2   3   4   5   6
    cut "\\e[$OY;${SX}H$C1C"       '' "$X1"',' '-' '+' '.'     #1
    cut "\\e[$[$OY+1];${SX}H$C1C"  '('     ' ' ' ' ' ' ' ' ')' #2
    cut "\\e[$[$OY+2];${SX}H$C1C"  '' "$X2"'`' '+' '-' '´'     #3
}

case $month in
    0[1-4]|12) C2C=$SKY$CYN;; # winter & early spring
    0[5-8]   ) C2C=$SKY$WHT;; # late spring & summer
    09|1[0-1]) C2C=$SKY$BLK;; # autumn
esac
sprite_cloud2 () {
    mov && BP2[i]="cloud2 $OX $OY 3 8 $SC $SM $CS $CL $AS $AL" || { unset BP2[i]; return; }
    X1="\\e[$OY;$[OX+1]H" X2="\\e[$[OY+2];$[OX+1]H"
    #012345678
    #1 ,-._..
    #2(      )
    #3 `-...´
    #                              1        2   3   4   5   6   7   8
    cut "\\e[$OY;${SX}H$C2C"       '' "$X1"',' '-' '.' '_' '.' '.'     #1   
    cut "\\e[$[$OY+1];${SX}H$C2C"  '('     ' ' ' ' ' ' ' ' ' ' ' ' ')' #2
    cut "\\e[$[$OY+2];${SX}H$C2C"  '' "$X2"'`' '-' '.' '.' '.' '´'     #3
}

case $month in
    0[1-4]|12) C3C=$SKY$BLD$CYN;; # winter & early spring
    0[5-8]   ) C3C=$SKY$BLD$WHT;; # late spring & summer
    09|1[0-1]) C3C=$SKY$DIM$BLK;; # autumn
esac
sprite_cloud3 () {
    mov && BP3[i]="cloud3 $OX $OY 3 11 $SC $SM $CS $CL $AS $AL" || { unset BP3[i]; return; }
    X1="\\e[$OY;$[OX+1]H" X2="\\e[$[OY+2];$[OX+1]H"
    #0123456789AB
    #1 ,+¯`.-¯`.
    #2(         )
    #3 `--.,,.-´
    #                              1        2   3   4   5   6   7   8   9   A   B
    cut "\\e[$OY;${SX}H$C3C"       '' "$X1"',' '+' '¯' '`' '.' '-' '¯' '`' '.'     #1
    cut "\\e[$[$OY+1];${SX}H$C3C"  '('     ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ' ')' #2
    cut "\\e[$[$OY+2];${SX}H$C3C"  '' "$X2"'`' '-' '-' '.' ',' ',' '.' '-' '´'     #3
}

#------------------------{ Trees }--------------------------------------------------------------------------------------
case $month in
    0[1-4]|12) T1C=$SKY$DIM$WHT tree1H=3;; # winter & early spring
    0[5-8]   ) T1C=$SKY$DIM$GRN tree1H=4;; # late spring & summer
    09|1[0-1]) T1C=$SKY$DIM$YLW tree1H=4;; # autumn
esac
sprite_tree1 () {
    case $month in
        0[1-4]|12)
        mov && BP1[i]="tree1 $OX $OY 3 2 $SC $SM $CS $CL $AS $AL" || { unset BP1[i]; return; }
        X1="\\e[$OY;$[OX+1]H" X2="\\e[$[OY+2];$[OX+1]H" CM1="$DIM$blk"
        #0123
        #1 |/
        #2\|
        #3 |
        #                              1           2      3
        cut "\\e[$OY;${SX}H$T1C"       ''    "$X1"'|'    '/'  #1
        cut "\\e[$[$OY+1];${SX}H$T1C"  '\\' "$CM1"'|'         #2
        cut "\\e[$[$OY+2];${SX}H$CM1"  ''    "$X2"'|';;       #3

        *)
        mov && BP1[i]="tree1 $OX $OY 4 2 $SC $SM $CS $CL $AS $AL" || { unset BP1[i]; return; }
        X1="\\e[$OY;$[OX+1]H" X2="\\e[$[OY+3];$[OX+1]H" CM1="$DIM$blk"
        #0123
        #1 _
        #2/ \
        #3\|/
        #4 |
        #                               1            2         3
        cut "\\e[$OY;${SX}H$T1C"       ''      "$X1"'_'            #1
        cut "\\e[$[$OY+1];${SX}H$T1C"  '/'          ' '       '\\' #2
        cut "\\e[$[$OY+2];${SX}H$T1C"  '\\'   "$CM1"'|' "$T1C"'/'  #3
        cut "\\e[$[$OY+3];${SX}H$T1C"  ''  "$X2$CM1"'|';;          #4
    esac
}

case $month in
    0[1-4]|12) T2C=$SKY$WHT tree2H=5;; # winter & early spring
    0[5-8]   ) T2C=$SKY$GRN tree2H=6;; # late spring & summer
    09|1[0-1]) T2C=$SKY$YLW tree2H=6;; # autumn
esac
sprite_tree2 () {
    case $month in
        0[1-4]|12)
        mov && BP2[i]="tree2 $OX $OY 5 5 $SC $SM $CS $CL $AS $AL" || { unset BP2[i]; return; }
        X1="\\e[$OY;$[OX+3]H" X2="\\e[$[OY+2];$[OX+1]H" X3="\\e[$[OY+3];$[OX+2]H" X4="\\e[$[OY+4];$[OX+2]H"
        #012345
        #1   |_
        #2\||/
        #3 \║|_
        #4  ║/
        #5  ║
        #                              1         2          3         4   5
        cut "\\e[$OY;${SX}H$T2C"       ''       ''         ''   "$X1"'|' '_'  #1
        cut "\\e[$[$OY+1];${SX}H$T2C"  '\\'     '|'  "$blk"'|'       '/'      #2
        cut "\\e[$[$OY+2];${SX}H$blk"  ''  "$X2"'\\'       '║' "$T2C"'|' '_'  #3
        cut "\\e[$[$OY+3];${SX}H$blk"  ''  ''         "$X3"'║'       '/'      #4
        cut "\\e[$[$OY+4];${SX}H$blk"  ''  ''         "$X4"'║';;              #5

        *)
        mov && BP2[i]="tree2 $OX $OY 6 5 $SC $SM $CS $CL $AS $AL" || { unset BP2[i]; return; }
        X1="\\e[$OY;$[OX+1]H" X2="\\e[$[OY+3];$[OX+1]H" X3="\\e[$[OY+4];$[OX+2]H" X4="\\e[$[OY+5];$[OX+2]H"
        #012345
        #1 _._
        #2/   \
        #3\ | /
        #4 \║/\
        #5  ║_/
        #6  ║
        #                              1       2          3         4         5
        cut "\\e[$OY;${SX}H$T2C"      '' "$X1"'_'        '.'       '_'             #1
        cut "\\e[$[$OY+1];${SX}H$T2C" '/'     ' '        ' '       ' '       '\\'  #2
        cut "\\e[$[$OY+2];${SX}H$T2C" '\\'    ' '  "$blk"'|'       ' ' "$T2C"'/'   #3
        cut "\\e[$[$OY+3];${SX}H$T2C" '' "$X2"'\\' "$blk"'║' "$T2C"'/'       '\\'  #4
        cut "\\e[$[$OY+4];${SX}H$blk" ''      ''    "$X3"'║' "$T2C"'_'       '/'   #5
        cut "\\e[$[$OY+5];${SX}H$blk" ''      ''    "$X4"'║'  ;;
    esac
}

case $month in
    0[1-4]|12) T3C=$SKY$BLD$cyn tree3H=8;; # winter & early spring
    0[5-8]   ) T3C=$SKY$BLD$GRN tree3H=9;; # late spring & summer
    09|1[0-1]) T3C=$SKY$DIM$red tree3H=9;; # autumn
esac
sprite_tree3 () {
    case "$day$month" in
        2[1-9]12|3[0-1]12|0[1-9]01|1001)
        mov && BP3[i]="tree3 $OX $OY 8 12 $SC $SM $CS $CL $AS $AL" || { unset BP3[i]; return; }
        X1="\\e[$OY;$[OX+6]H"     X2="\\e[$[OY+1];$[OX+4]H" X3="\\e[$[OY+2];$[OX+4]H" X4="\\e[$[OY+3];$[OX+4]H"
        X5="\\e[$[OY+4];$[OX+2]H" X6="\\e[$[OY+5];$[OX+2]H" X7="\\e[$[OY+7];$[OX+6]H"
        #0123456789ABC
        #1      ★
        #2    _❅|●
        #3    -/○\❄-
        #4    ●/|\\○
        #5  _/❄/●\❅\
        #6  ○///|\❄\● 
        #7_/❅/●/|○\❅\-
        #8      ║
        #                             1   2            3         4           5         6         7         8          9          A          B    C
        cut "\\e[$OY;${SX}H$RED"      ''  ''          ''        ''          ''        ''   "$X1"'★'                                                 #1
        cut "\\e[$[$OY+1];${SX}H$GRN" ''  ''          ''        ''     "$X2"'_' "$cyn"'❅' "$GRN"'|' "$BLU"'●'                                       #2
        cut "\\e[$[$OY+2];${SX}H$GRN" ''  ''          ''        ''     "$X3"'-'       '/' "$YLW"'○' "$GRN"'\\'  "$CYN"'❄' "$GRN"'-'                 #3
        cut "\\e[$[$OY+3];${SX}H$GRN" ''  ''          ''        '' "$X4$RED"'●' "$GRN"'/'       '|'       '\\'       '\\' "$ylw"'○'                 #4
        cut "\\e[$[$OY+4];${SX}H$GRN" ''  ''     "$X5"'_'       '/'   "$cyn"'❄' "$GRN"'/' "$blu"'●' "$GRN"'\\'  "$cyn"'❅' "$GRN"'\\'                #5
        cut "\\e[$[$OY+5];${SX}H$GRN" ''  '' "$X6$red"'○' "$GRN"'/'         '/'       '/'       '|'       '\\'  "$CYN"'❄' "$GRN"'\\' "$RED"'●'      #6
        cut "\\e[$[$OY+6];${SX}H$GRN" '_' '/'   "$cyn"'❅' "$GRN"'/'   "$YLW"'●' "$GRN"'/'       '|' "$RED"'○'   "$GRN"'\\' "$cyn"'❅' "$GRN"'\\' '-' #7
        cut "\\e[$[$OY+7];${SX}H$BLK" ''  ''          ''        ''          ''        ''   "$X7"'║';;                                               #8

        0[1-4]|12)
        mov && BP3[i]="tree3 $OX $OY 8 9 $SC $SM $CS $CL $AS $AL" || { unset BP3[i]; return; }
        X1="\\e[$OY;$[OX+2]H"     X2="\\e[$[OY+1];$[OX+3]H" X3="\\e[$[OY+3];$[OX+1]H" X4="\\e[$[OY+4];$[OX+3]H"
        X5="\\e[$[OY+5];$[OX+4]H" X6="\\e[$[OY+6];$[OX+4]H" X7="\\e[$[OY+7];$[OX+4]H"
        #0123456789
        #1  \|
        #2   \| |_
        #3_\_ ║/
        #4 /\ ║ \/_
        #5   \║ /
        #6    ║/
        #7    ║
        #8    ║
        #                              1        2         3         4         5         6         7    8   9
        cut "\\e[$OY;${SX}H$T3C"      ''       ''   "$X1"'\\'      '|'                                        #1
        cut "\\e[$[$OY+1];${SX}H$BLK" ''       ''        ''   "$X2"'\\'      '|'       ' ' "$T3C"'|'  '_'     #2
        cut "\\e[$[$OY+2];${SX}H$T3C" '_'      '\\'      '_'       ' ' "$BLK"'║'       '/'                    #3
        cut "\\e[$[$OY+3];${SX}H$T3C" ''  "$X3"'/'       '\\'      ' ' "$BLK"'║' "$T3C"' '       '\\' '/' '_' #4
        cut "\\e[$[$OY+4];${SX}H$BLK" ''       ''        ''   "$X4"'\\'      '║'       ' '       '/'          #5
        cut "\\e[$[$OY+5];${SX}H$BLK" ''       ''        ''        ''   "$X5"'║'       '/'                    #6
        cut "\\e[$[$OY+6];${SX}H$BLK" ''       ''        ''        ''   "$X6"'║'                              #7
        cut "\\e[$[$OY+7];${SX}H$BLK" ''       ''        ''        ''   "$X7"'║';;                            #8

        *)
        mov && BP3[i]="tree3 $OX $OY 9 9 $SC $SM $CS $CL $AS $AL" || { unset B3[i]; return; }
        X1="\\e[$OY;$[OX+3]H"     X2="\\e[$[OY+1];$[OX+2]H" X3="\\e[$[OY+2];$[OX+1]H" X4="\\e[$[OY+5];$[OX+3]H"
        X5="\\e[$[OY+6];$[OX+4]H" X6="\\e[$[OY+7];$[OX+4]H" X7="\\e[$[OY+8];$[OX+4]H"
        #0123456789
        #1   _._
        #2  /   \
        #3 _\ | /
        #4/  \║/__
        #5\_\/║/  \
        #6   \║|/_/
        #7    ║/
        #8    ║
        #9    ║
        #                             1       2          3          4          5         6         7         8   9
        cut "\\e[$OY;${SX}H$T3C"      ''      ''        ''    "$X1"'_'        '.'       '_'                          #1
        cut "\\e[$[$OY+1];${SX}H$T3C" ''      ''   "$X2"'/'        ' '        ' '       ' '       '\\'               #2
        cut "\\e[$[$OY+2];${SX}H$T3C" '' "$X3"'_'       '\\'       ' '  "$BLK"'|'       ' ' "$T3C"'/'                #3
        cut "\\e[$[$OY+3];${SX}H$T3C" '/'     ' '       ' '        '\\' "$BLK"'║' "$T3C"'/'       '_'       '_'      #4
        cut "\\e[$[$OY+4];${SX}H$T3C" '\\'    '_' "$BLK"'\\' "$T3C"'/'  "$BLK"'║' "$T3C"'/'       ' '       ' ' '\\' #5
        cut "\\e[$[$OY+5];${SX}H$BLK" ' '     ' '       ' '   "$X4"'\\'       '║' "$T3C"'|' "$BLK"'/' "$T3C"'_' '/'  #6
        cut "\\e[$[$OY+6];${SX}H$BLK" ''      ''        ''         ''    "$X5"'║' '/'                                #7
        cut "\\e[$[$OY+7];${SX}H$BLK" ''      ''        ''         ''    "$X6"'║'                                    #8
        cut "\\e[$[$OY+8];${SX}H$BLK" ''      ''        ''         ''    "$X7"'║';;                                  #9
    esac
}
#------------------------{ BOOM }---------------------------------------------------------------------------------------
sprite_boom () {
    BX=$OX BY=$OY
    [[ $AS -ge $AL ]] && { unset BP3[i]; return; }
    boom=(
        # .-.
        #(   )'
        # `-´
             "\e[$BY;$[BX+3]H$red.-.$SKY"
        "\e[$[BY+1];$[BX+2]H$red(   )$SKY"
       "\e[$[BY+2];$[BX+3]H$red"'`-´'$SKY
        '' ''
        # , - .
        #(     )
        # . _ .
            "\e[$BY;$[BX+2]H$RED, - .$SKY"
       "\e[$[BY+1];$[BX+1]H$RED(     )$SKY"
        "\e[$[BY+2];$[BX+2]H$RED. _ .$SKY"
        '' ''
        #  ´ ¯ `
        #(       )
        # +  _ .' 
      "\e[$BY;$[BX+2]H$DIM$RED"'´ ¯ `'$SKY
    "\e[$[BY+1];${BX}H$DIM$RED(       )$SKY"
   "\e[$[BY+2];$[BX+1]H$DIM$RED+  _ .'"$SKY
        '' ''
        #  .     .
        #
        #-         -
        #
        # '   .   `
       "\e[$[BY-1];$[BX+1]H$RED.     .$SKY"
          "\e[$BY;$[BX+1]H$SKY         $SKY"
     "\e[$[BY+1];$[BX-1]H$red-         -$SKY"
     "\e[$[BY+2];$[BX+1]H$SKY           $SKY"
        "\e[$[BY+3];${BX}H$red'   .   "'`'$SKY
        #eraser
       "\e[$[BY-1];$[BX+1]H$SKY       "
          "\e[$BY;$[BX+1]H$SKY         "
     "\e[$[BY+1];$[BX-1]H$SKY           "
     "\e[$[BY+2];$[BX+1]H$SKY           "
        "\e[$[BY+3];${BX}H$SKY         ")
    screen+="${boom[@]:$((AS*5)):5}"
    mov; BP3[i]="boom $BX $BY 0 0 $SC $SM $CS $CL $AS $AL"
}

#================================================{ Functions }==========================================================
get_dimensions () {
    size=( $(stty size) )
    endx=${size[1]}
    endy=${size[0]}
enmyendy=$[endy-7]
boomendx=$[endx-10]
bullendx=$[endx-4 ]
heroendx=$[endx-15]
heroendy=$[endy-7 ]
enmyendy=$[endy-7 ]
bossendx=$[endx-11]
bossendy=$[endy-7 ]
bosshbar=$[endx-10]
lineendy=$[endy-2 ]
Sunsendx=$[endx-18]
tre1endy=$[endy-tree1H-2]
tre2endy=$[endy-tree2H-2]
tre3endy=$[endy-tree3H-2]
}

bye () { stty echo; printf "$CON$DEF"; exit $1; }
cut () { screen+="$1"; shift; printf -v spr %s "${@:$CS:$CL}"; screen+="${spr//_Z_/ }$SKY "; }
mov () {
    case $SC in
        0) [[ $OX -le -$OW ]] && return 1
           [[ $AS -ge  $AL ]] && AS=0 || ((AS++)) # sprites animation
           [[ $OX -le  1   ]] && ((CS++))
           ((OX--)); ((CL++)); SC=$SM;;
        *) ((SC--));;
    esac
    [[ $OX -le 1 ]] && SX=0 || SX=$OX
}

get_obj_data () {
    OT=${OI[0]}   # object type
    OX=${OI[1]}   # X coordinate
    OY=${OI[2]}   # Y coordinate
    OH=${OI[3]}   # object hight
    OW=${OI[4]}   # object width
    SC=${OI[5]}   # speed counter
    SM=${OI[6]}   # speed max
    CS=${OI[7]}   # cuting start
    CL=${OI[8]}   # cuting lenght
    AS=${OI[9]}   # animation start
    AL=${OI[10]}  # animation lenght
    [[ $OT ]] && sprite_$OT
}

server_read () {
    read -t$spd -srn1 input &> /dev/null
    case $input in
        [wW]) [[ $H1Y    -gt 1             ]] && ((H1Y--));;
        [aA]) [[ $H1X    -gt 1             ]] && ((H1X--));;
        [sS]) [[ $H1Y    -lt $heroendy     ]] && ((H1Y++));;
        [dD]) [[ $H1X    -lt $heroendx     ]] && ((H1X++));;
        [pP]) [[ $ammo -ge $G && $CD -eq 0 ]] && { CD=7; case $G in
            1) PIU+=("$H1CX $H1CY 1");;
            2) PIU+=("$H1CX $[$H1CY+1] 1" "$H1CX $[$H1CY-1] 1");;
            3) PIU+=("$H1CX $[$H1CY+1] 1" "$H1CX $[$H1CY-1] 1" "$[$H1CX+1] $H1CY 1");;
            4) PIU+=("$[$H1CX+1] $[$H1CY+1] 1" "$[$H1CX+1] $[$H1CY-1] 1" "$H1CX $[$H1CY+2] 1" "$H1CX $[$H1CY-2] 1");;
            5) PIU+=("$[$H1CX+1] $[$H1CY+1] 1" "$[$H1CX+1] $[$H1CY-1] 1" "$H1CX $[$H1CY+2] 1" "$H1CX $[$H1CY-2] 1" "$[$H1CX+2] $H1CY 1");;
        esac; ((ammo-=$G)); };;
    esac
}

boom () {
    XB=$1 YB=$2
    [[ $XB -gt $boomendx ]] && XB=$boomendx
    BP3+=("boom $XB $YB 0 0 0 2 0 0 0 5")
}

BOOM () {
    XB=$1 YB=$2
    [[ $XB -gt $boomendx ]] && XB=$boomendx
    BP3+=("boom  $XB     $YB    0 0 0 $[RANDOM%3] 0 0 0 5"
          "boom $[XB+5]  $YB    0 0 0 $[RANDOM%3] 0 0 0 5"
          "boom $[XB+1] $[YB+2] 0 0 0 $[RANDOM%3] 0 0 0 5"
          "boom $[XB+5] $[YB+2] 0 0 0 $[RANDOM%3] 0 0 0 5"
          "boom  $XB    $[YB+1] 0 0 0 $[RANDOM%3] 0 0 0 5")
}

fps_counter () {
    [[ $SECONDS -gt $sec ]] && {
        FPS=$FPSC AVG+=($FPS)
        [[ $FPSL ]] || FPSL=$FPS
        [[ $FPS -gt $FPSM  ]] && FPSM=$FPS
        [[ $FPS -lt $FPSL  ]] && FPSL=$FPS
        (( ${#AVG[@]} == 5 )) && { avg="${AVG[@]}"; FPSA=$(( (${avg// /+})/5 )); AVG=(); }
        sec=$SECONDS
        FPSC=0
    } || ((FPSC++))
}

fill_screen () {
    for ((i=0;         i<$lineendy; i++)); do printf "$SKY%${endx}s"; done
    for ((i=$lineendy; i<$endy;     i++)); do printf "$LND%${endx}s"; done
}

add_backgound () {
    #-{ Add msngr }------------------------------------------------------------
    case $[RANDOM % $MSN] in 0) BP2+=("msngr $endx $[RANDOM%enmyendy+3] 4 20 0 $[RANDOM%2] 1 0 $[RANDOM%3] 3");; esac

    #-{ Add clouds }-----------------------------------------------------------
    case $[RANDOM % $CLD]:$[RANDOM % 3 + 1] in
        0:1) BP1+=("cloud1 $endx $[RANDOM % 10 + 2] 3 6  6 6 1 0 0 0");;
        0:2) BP2+=("cloud2 $endx $[RANDOM % 10 + 2] 3 8  4 4 1 0 0 0");;
        0:3) BP3+=("cloud3 $endx $[RANDOM % 10 + 2] 3 11 2 2 1 0 0 0");;
    esac

    #-{ Add trees }------------------------------------------------------------
    case $[RANDOM % $TRE]:$[RANDOM % 3 + 1] in
        0:1) BP1+=("tree1 $endx $tre1endy 3 2 6 6 1 0 0 0");;
        0:2) BP2+=("tree2 $endx $tre2endy 6 5 4 4 1 0 0 0");;
        0:3) BP3+=("tree3 $endx $tre3endy 9 9 2 2 1 0 0 0");;
    esac

    #-{ Print moving land }----------------------------------------------------
    screen+="\e[$lineendy;1H$LND${land:$[1-$LX]:$endx}"; [[ $LX -lt -$[$LN/2] ]] && LX=-1 || ((LX--))
}
#======================================{ Main game loop single or server team mode }====================================
game () {
    while true; do
        #-{ Empty screen, count fps, set timings}------------------------------
        [[ $M -ge 10 ]] && M=0 || ((M++)) # enemies born rate
        screen=; fps_counter
        ENM=("${ENM[@]}")
        HER=("${HER[@]}")
        BP1=("${BP1[@]}")
        BP2=("${BP2[@]}")
        BP3=("${BP3[@]}")
        [[ $background ]] && add_backgound

        #-{ Add aliens }-------------------------------------------------------
        [[ $enumber -lt $enmax && $M -eq 0 ]] && {
            ENM+=("alien $endx $[RANDOM%enmyendy+3] 3 5 0 $[RANDOM%2] 1 0 $[RANDOM%3] 3")
            ((enumber++))
        }

        #-{ Print FPS }--------------------------------------------------------
        screen+="\e[$endy;2H${DEF}FPS:$RED$FPS ${DEF}max:$RED$FPSM ${DEF}low:$RED$FPSL ${DEF}avg:$RED$FPSA "

        #-{ Move bitplans }----------------------------------------------------
        for i in ${!BP1[@]}; { OI=(${BP1[i]}); get_obj_data; }
        for i in ${!BP2[@]}; { OI=(${BP2[i]}); get_obj_data; }
        for i in ${!HER[@]}; { OI=(${HER[i]}); get_obj_data; }
        for i in ${!ENM[@]}; { OI=(${ENM[i]}); get_obj_data; }
        for i in ${!BP3[@]}; { OI=(${BP3[i]}); get_obj_data; }

        #-{ Print everything }-------------------------------------------------
        printf "$screen"
    done
}
#=================================================={ Initialisation }===================================================
trap : ALRM
trap bye INT TERM SIGINT SIGTERM EXIT
get_dimensions; stty -echo; printf "$COF"; clear
H1C=${DHC}; S1C=${DSC}; H1S=${DHS};
#-{ Generate grass }-----------------------------------------------------------
for ((i=0; i<$endx; i++)); do land+=${grass[$[RANDOM % ${#grass[*]}]]}; done; land+=$land; LN=${#land}
fill_screen
H1X=10 H1Y=10 HER[0]="hero1 6 14 $H1X $H1Y 0 0 1 15 0 3"
game



