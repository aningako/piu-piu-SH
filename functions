#!/bin/bash
#================================================{ Functions }==========================================================
get_dimensions () {
    size=($(stty size))
    endx=${size[1]}
    endy=${size[0]}
    halfendx=$[endx/2 ]
    halfendy=$[endy/2 ]
    boomendx=$[endx-10]
    bullendx=$[endx-4 ]
    heroendx=$[endx-15]
    heroendy=$[endy-8 ]
    enmyendy=$[endy-9 ]
    bossendx=$[endx-14]
    bossendy=$[endy-7 ]
    bosshbar=$[endx-10]
    lineendy=$[endy-2 ]
    Sunsendx=$[endx-18]
    hos1endy=$[endy-4 ]
    hos2endy=$[endy-11]
    hos3endy=$[endy-6 ]
    msgrendy=$[endy-10]
    tre1endy=$[endy-tree1H-2]
    tre2endy=$[endy-tree2H-2]
    tre3endy=$[endy-tree3H-2]
}

cursor () {
    case $1 in
         on) stty  echo; printf "$CON";;
        off) stty -echo; printf "$COF";;
    esac
}
bye () { cursor on; exit $1; }
cut () {
    xcord=$1 ycord=$2 color=$3; shift 3
    screen+="\e[$ycord;${xcord}H$color"
    printf -v spr %s "${@:$CS:$CL}"
    spr="${spr//_Y_/'\e['$ycord;}"
    screen+="${spr//⎕/ }"
}

mov () {
    case $1  in -) cuter=++;; +) cuter=--;; esac
    case $SC in
        0) [[ $OX -le -$OW   ]] && return 1
           [[ $OX -gt  $endx ]] && return 1
           [[ $AS -ge  $AL   ]] && AS=0  || ((AS++)) # sprites animation
           [[ $OX -le  1     ]] && ((CS++))
           ((OX$1$1)); ((CL$cuter)); SC=$SM
           [[ $CL -lt 0 ]] && CL=0;;
        *) ((SC--));;
    esac
    [[ $OX -le 1 ]] && SX=0 || SX=$OX
}

add_enm () {
    [[ $BR -gt 0 ]] && ((BR--))
    [[ $enumber -lt $enmax && $BR -eq 0 ]] || return
    ENM+=("alien $1 $2 3 5 0 $[RANDOM%2] 1 ${3:-0} $[RANDOM%3] 3 ${#ENM[@]}")
    ((enumber++))
    BR=20
}

bonus () { # get random bonus from alien or not
    case $[RANDOM % $rnd] in
        0) ENM+=("${bonuses[$[RANDOM%${#bonuses[@]}]]} $OX $[OY-1] 3 5 0 2 1 0 0 0 ${#ENM[@]}")
    esac
}

mess () {
    cursor off
    XY 1 1 ${DEF}; clear
    case $1 in
        "win" ) sprite_win ; XY 0 ${endy}; read -t3 -n1000 trash; bye 0;;
        "lose") sprite_lose; XY 0 ${endy}; read -t3 -n1000 trash; bye 1;;
        "help") sprite_help;;
    esac
}

print_sprite () {
    OT=${OI[0]}   # object type
    OX=${OI[1]}   # X coordinate
    OY=${OI[2]}   # Y coordinate
    OH=${OI[3]}   # object hight
    OW=${OI[4]}   # object width
    SC=${OI[5]}   # speed counter
    SM=${OI[6]}   # speed max
    CS=${OI[7]}   # cuting start
    CL=${OI[8]}   # cuting lenght
    AS=${OI[9]}   # animation start
    AL=${OI[10]}  # animation lenght
    C1=${OI[11]}  # custom obj parameter 1
    C2=${OI[12]}  # custom obj parameter 2
    [[ $OT ]] && sprite_$OT
}

server_read () {
    read -t$spd -srn1 input &> /dev/null
    case $input in
        [wW]) [[ $H1Y  -gt 2               ]] && ((H1Y--));;
        [aA]) [[ $H1X  -gt 1               ]] && ((H1X--));;
        [sS]) [[ $H1Y  -lt $heroendy       ]] && ((H1Y++));;
        [dD]) [[ $H1X  -lt $heroendx       ]] && ((H1X++));;
        [pP]) [[ $ammo -ge $G && $C1 -eq 0 ]] && { C1=7; case $G in
            1) PIU+=("piu $[H1X+12] $[H1Y+3] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 a");; # -=>

            2) PIU+=("piu $[H1X+12] $[H1Y+4] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 a"    # -=>
                                                                                            #
                     "piu $[H1X+12] $[H1Y+2] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 a");; # -=>

            3) PIU+=("piu $[H1X+12] $[H1Y+2] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 a"    # -=>
                     "piu $[H1X+13] $[H1Y+3] 1 4 0 0 1 $[endx-(H1X+13)] $[RANDOM%3] 3 a"    #  -=>
                     "piu $[H1X+12] $[H1Y+4] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 a");; # -=>

            4) PIU+=("piu $[H1X+12] $[H1Y+1] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 a"    # -=>
                     "piu $[H1X+13] $[H1Y+2] 1 4 0 0 1 $[endx-(H1X+13)] $[RANDOM%3] 3 a"    #  -=>
                                                                                            #
                     "piu $[H1X+13] $[H1Y+4] 1 4 0 0 1 $[endx-(H1X+13)] $[RANDOM%3] 3 a"    #  -=>
                     "piu $[H1X+12] $[H1Y+5] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 a");; # -=>

            5) PIU+=("piu $[H1X+12] $[H1Y+1] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 a"    # -=>
                     "piu $[H1X+13] $[H1Y+2] 1 4 0 0 1 $[endx-(H1X+13)] $[RANDOM%3] 3 a"    #  -=>
                     "piu $[H1X+14] $[H1Y+3] 1 4 0 0 1 $[endx-(H1X+14)] $[RANDOM%3] 3 a"    #   -=>
                     "piu $[H1X+13] $[H1Y+4] 1 4 0 0 1 $[endx-(H1X+13)] $[RANDOM%3] 3 a"    #  -=>
                     "piu $[H1X+12] $[H1Y+5] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 a");; # -=>
        esac; ((ammo-=$G)); };;
    esac
}

client_read () {
    input2=$(nc -l -p $sport)
    case $input2 in
        [wW]) [[ $H2Y   -gt 2                ]] && ((H2Y--));;
        [aA]) [[ $H2X   -gt 1                ]] && ((H2X--));;
        [sS]) [[ $H2Y   -lt $heroendy        ]] && ((H2Y++));;
        [dD]) [[ $H2X   -lt $heroendx        ]] && ((H2X++));;
        [pP]) [[ $ammo2 -ge $G2 && $C1 -eq 0 ]] && { C1=7; case $G2 in
            1) PIU+=("piu $[H1X+12] $[H1Y+3] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 b");; # -=>

            2) PIU+=("piu $[H1X+12] $[H1Y+4] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 b"    # -=>
                                                                                            #
                     "piu $[H1X+12] $[H1Y+2] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 b");; # -=>

            3) PIU+=("piu $[H1X+12] $[H1Y+2] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 b"    # -=>
                     "piu $[H1X+13] $[H1Y+3] 1 4 0 0 1 $[endx-(H1X+13)] $[RANDOM%3] 3 b"    #  -=>
                     "piu $[H1X+12] $[H1Y+4] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 b");; # -=>

            4) PIU+=("piu $[H1X+12] $[H1Y+1] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 b"    # -=>
                     "piu $[H1X+13] $[H1Y+2] 1 4 0 0 1 $[endx-(H1X+13)] $[RANDOM%3] 3 b"    #  -=>
                                                                                            #
                     "piu $[H1X+13] $[H1Y+4] 1 4 0 0 1 $[endx-(H1X+13)] $[RANDOM%3] 3 b"    #  -=>
                     "piu $[H1X+12] $[H1Y+5] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 b");; # -=>

            5) PIU+=("piu $[H1X+12] $[H1Y+1] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 b"    # -=>
                     "piu $[H1X+13] $[H1Y+2] 1 4 0 0 1 $[endx-(H1X+13)] $[RANDOM%3] 3 b"    #  -=>
                     "piu $[H1X+14] $[H1Y+3] 1 4 0 0 1 $[endx-(H1X+14)] $[RANDOM%3] 3 b"    #   -=>
                     "piu $[H1X+13] $[H1Y+4] 1 4 0 0 1 $[endx-(H1X+13)] $[RANDOM%3] 3 b"    #  -=>
                     "piu $[H1X+12] $[H1Y+5] 1 4 0 0 1 $[endx-(H1X+12)] $[RANDOM%3] 3 b");; # -=>
        esac; ((ammo2-=$G2)); };;
    esac
}

collision () {
    hero=$1 re="$2"
    [[ ${ENM[@]} =~ $re ]] && {
        match=($BASH_REMATCH)
        obj_i=${match[@]:11:1}
        obj_x=${match[@]:1:1}
        obj_y=${match[@]:2:1}
        case $match:$hero in
               boss:*) ((bhealth--))   ; boom $3   $4; return 0;;
                  *:*) unset ENM[obj_i]; boom $obj_x $obj_y;;&
              gunup:1) [[ $G  -lt 5 ]] && ((G++)) ; return 1;;
              gunup:2) [[ $G2 -lt 5 ]] && ((G2++)); return 1;;
               life:1) ((life++))    ; return 1;;
               life:2) ((life2++))   ; return 1;;
               ammo:1) ((ammo+=100)) ; return 1;;
               ammo:2) ((ammo2+=100)); return 1;;
              alien:a) ((enumber--)) ;((frags++)) ; bonus; return 0;;
              alien:b) ((enumber--)) ;((frags2++)); bonus; return 0;;
              alien:*) ((enumber--)) ; return 0;;
              bfire:*) return 0;;
        esac
    }
}

boom () {
    XB=$1 YB=$2
    [[ $XB -gt $boomendx ]] && XB=$boomendx
    BP3+=("boom $XB $YB 0 0 0 $[RANDOM%3] 1 9 0 5")
}

BOOM () {
    XB=$1 YB=$2
    [[ $XB -lt 1 ]] && XB=1
    [[ $XB -gt $boomendx ]] && XB=$boomendx
    BP3+=("boom  $XB     $YB    0 0 0 $[RANDOM%3] 1 9 0 5"
          "boom $[XB+5]  $YB    0 0 0 $[RANDOM%3] 1 9 0 5"
          "boom $[XB+1] $[YB+2] 0 0 0 $[RANDOM%3] 1 9 0 5"
          "boom $[XB+5] $[YB+2] 0 0 0 $[RANDOM%3] 1 9 0 5"
          "boom  $XB    $[YB+1] 0 0 0 $[RANDOM%3] 1 9 0 5")
}

fps_counter () {
    [[ $SECONDS -gt $sec ]] && {
        FPS=$FPSC AVG+=($FPS)
        [[ $FPSL ]] || FPSL=$FPS
        [[ $FPS -gt $FPSM  ]] && FPSM=$FPS
        [[ $FPS -lt $FPSL  ]] && FPSL=$FPS
        (( ${#AVG[@]} == 5 )) && { avg="${AVG[@]}"; FPSA=$(( (${avg// /+})/5 )); AVG=(); }
        sec=$SECONDS
        FPSC=0
    } || ((FPSC++))
    #-{ Print FPS }------------------------------------------------------------
    screen+="\e[$endy;2H${DEF}FPS:$RED$FPS ${DEF}max:$RED$FPSM ${DEF}low:$RED$FPSL ${DEF}avg:$RED$FPSA "
}

status () {
    #-{ Print game status }----------------------------------------------------
    case "$day$month$virus" in
        *covid-19) screen+="\e[1;2H$SKY${BLK}killed viruses: $SKY$RED$frags$SKY ${BLK}Life: $SKY$RED$life$SKY ${BLK}Meds: $SKY$RED$ammo$SKY ";;
                *) screen+="\e[1;2H$SKY${BLK}killed aliens: $SKY$RED$frags$SKY ${BLK}Life: $SKY$RED$life$SKY ${BLK}Ammo: $SKY$RED$ammo$SKY " ;;
    esac
}

fill_screen () {
    for ((i=0;         i<$lineendy; i++)); do printf "$SKY%${endx}s"; done
    for ((i=$lineendy; i<$endy;     i++)); do printf "$LND%${endx}s"; done
}

add_backgound () {
    rndy=$[2+RANDOM%10]; [[ $rndy -gt $[3+enmyendy] ]] && rndy=$[3+enmyendy]
    #-{ Add birds }------------------------------------------------------------
    case $[RANDOM % $BRD] in 0) BP1+=("bird  $endx $rndy 2 2  0 $[3+RANDOM%3] 1 0 $[RANDOM%2] 2");; esac

    #-{ Add msngr }------------------------------------------------------------
    case $[RANDOM % $MSN] in 0) BP2+=("msngr $endx $rndy 4 20 0 $[1+RANDOM%4] 1 0 $[RANDOM%3] 3");; esac

    #-{ Add clouds }-----------------------------------------------------------
    case $[RANDOM % $CLD]:$[RANDOM % 3 + 1] in
        0:1) BP1+=("cloud1 $endx $rndy 3 6  6 $[6+RANDOM%2] 1 0 0 0");;
        0:2) BP2+=("cloud2 $endx $rndy 3 8  4 $[4+RANDOM%2] 1 0 0 0");;
        0:3) BP3+=("cloud3 $endx $rndy 3 11 2 $[2+RANDOM%2] 1 0 0 0");;
    esac

    #-{ Add house }------------------------------------------------------------
    case $[RANDOM % $HOU]:$[RANDOM % 3 + 1] in
        0:1) BP1+=("house1 $endx $hos1endy 2 6  6 $[6+RANDOM%2] 1 0 0 0");;
        0:2) BP2+=("house2 $endx $hos2endy 9 30 4 $[4+RANDOM%2] 1 0 0 0");;
        0:3) BP3+=("house3 $endx $hos3endy 4 17 2 $[2+RANDOM%2] 1 0 0 0");;
    esac

    #-{ Add trees }------------------------------------------------------------
    case $[RANDOM % $TRE]:$[RANDOM % 3 + 1] in
        0:1) BP1+=("tree1 $endx $tre1endy 3 2 6 $[6+RANDOM%2] 1 0 0 0");;
        0:2) BP2+=("tree2 $endx $tre2endy 6 5 4 $[4+RANDOM%2] 1 0 0 0");;
        0:3) BP3+=("tree3 $endx $tre3endy 9 9 2 $[2+RANDOM%2] 1 0 0 0");;
    esac

    #-{ Print moving land }----------------------------------------------------
    screen+="\e[$lineendy;1H$LND${land:$[1-${LX:-1}]:$endx}"; [[ ${LX:-1} -lt -$[$LN/2] ]] && LX=-1 || ((LX--))
}

#------------------------{ Intro }--------------------------------------------------------------------------------------
intro () {
    i=0
    INT=("PIU $endx 3 9 41 0 0 1 0          0 0 $[endx/2-35]"
         "PIU $endx 3 9 41 0 0 1 0          0 0 $[endx/2-1]"
         "ARR 1    12 6 28 0 0 0 $[endx-29] 0 0 $[endx/2-16]")
    while true; do
        sleep $spd; screen=
        OI=(${INT[i]})
        print_sprite || ((i++))
        printf "$screen"
        [[ $i -gt ${#INT[@]} ]] && break
    done
}

hero_config () {
    hero_color=($BLK $RED $GRN $YLW $BLU $MGN $CYN $WHT); HCN=${#hero_color[*]}; HCI=0;
    star_color=($BLK $RED $GRN $YLW $BLU $MGN $CYN $WHT); SCN=${#star_color[*]}; SCI=0;
    hero_star=(★ ☭ ✚ ✙ ✠ ✡ ✦ ✧ ✩ ✪ ☘ ☠ ☢ ☣ ☯ ❃ ❂ ❁ ✿ ❀ ✣ ♣ ♠ ♥ ♦ ❤ ● ☻ ♀ ♂)
    HSI=0 HSN=${#hero_star[*]} H1C=${H1C:-$DHC} H1S=${H1S:-$DHS} S1C=${S1C:-$DSC}

    [[ $AS -gt 0 ]] && ((AS--)) || AS=3
    CM1=$SKY$H1C$BLD CM2=$SKY$DIM$H1C CM3=$SKY$H1C CM4=$SKY$BLD$H1C$UND TR=${tailrotor[AS]} SX=$[$endx/2-9] OY=$[$endy/2-6] CS=1 CL=20
    # Using the same 'cut' function to print hero as in the game to preserve this nicely done tabled structure
    ######X####Y#####CLR  1   2   3       4        5       6       7       8        9       A        B       C       D       E   F   G  #0
    cut $SX  $OY    $SKY ' ' ' ' ' '     ' '      ' '     ' '     ' '     ' '      ' '     ' '      ' '     ' '     ' '     ' ' ' ' ' ' #1
    cut $SX $[OY+1] $CM1 ' ' '_' '_'     ' '                                         ${mainrotor[AS]}                               ' ' #2
    cut $SX $[OY+2] $CM2 ' ' '|' $TR $CM1'\\' $CM1'_' $CM1'_' $CM1'_' $CM3'.'  $CM3'-' $CM3'╨'  $CM4'─' $CM4'｡' $CM1'_' $SKY' ' ' ' ' ' #3
    cut $SX $[OY+3] $CM2 ' ' '`' '─'     '´'      '‾'     '‾'     '‷'     '\\' $blk'°' $S1C$H1S $SKY' ' $blk'º' $blk'¯' $CM1']' '─' ' ' #4
    cut $SX $[OY+4] $CM2 ' ' ' ' ' '     ' '      ' '     ' '     ' '     ' '      '‾'     '‾'      '‾'     '‾'     '‾' $SKY' ' ' ' ' ' #5
    cut $SX $[OY+5] $SKY ' ' ' ' ' '     ' '      ' '     ' '     ' '     ' '      ' '     ' '      ' '     ' '     ' '     ' ' ' ' ' ' #6
    printf "$screen"
}

item=1
selector () {
    read -t$spd -srn1 input &> /dev/null
    case $input in
        [wW]) [[ $item -gt 1 ]] && ((item--));;
        [aA]) :;;
        [sS]) [[ $item -lt $[${#items[@]}-1] ]] && ((item++));;
        [dD]) :;;
        [pP]) return $item;; # -=>
    esac;     return 0
}

printf -v eraser %20s
clr    () { for i in ${!items[@]}; { XY $[$endx/4] $[$endy-6+i] "$eraser"; }; }
back   () { clr; menu; }
start  () { return  1; }
team   () { type=duel; multiplayer; }
duel   () { type=team; multiplayer; }
server () { game=server; clr; menu; }
single () { game=single; clr; menu; }
cancel () { apply; H1C=$DHC; H1S=$DHS; S1C=$DSC; }
client () { clr; game=client; enter_server; clr; menu; }
apply  () { printf "$DEF "; clear; intro; show_hero=; item=1; items=('' "start $game" 'multiplayer' 'configure' 'exit'); }
configure    () { clear; show_hero=1; items=('' 'Hero  sign' 'Sign color' 'Hero color' 'apply' 'cancel'); }
multiplayer  () { clr; items=('' 'server' 'client' 'single' "$type" 'back'); }
enter_server () {
    XY $[$endx/2-10] $[$endy-4] "${RED}Enter server IP: "
    XY $[$endx/2-10] $[$endy-3] "$BLD$WHT"
    cursor on; read -p ' ' -e saddr; cursor off
}

game=single
type=team
menu () {
     item=1 MX=$[$endx/4] MY=$[$endy-6]
    items=('' "start $game" 'multiplayer' 'configure' 'exit')
    while true; do
        selector || ${items[$?]// */} || break
        [[ $show_hero ]] && hero_config
        for i in ${!items[@]}; {
            [[ $i -eq $item ]] && selected=$BLD$RED || selected=$DEF
            XY $MX $[MY+i] "$selected${items[i]}"
        }
    done
}
